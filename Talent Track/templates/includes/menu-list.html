{% load static i18n tt_roles %}
<ul class="navbar-nav">

  {% with url_name=request.resolver_match.url_name %}
  {% with admin_active=url_name|url_in:"tt_empresa_list,tt_unidad_list,tt_puesto_list,tt_turno_list" %}
  {% with oper_active=url_name|url_in:"tt_empleado_list,tt_empleado_create,tt_empleado_update,tt_asistencia_list,tt_asistencia_hoy,tt_ausencia_list,tt_kpi_list,tt_evaluacion_list" %}
  {% with sec_active=url_name|url_in:"tt_usuario_list,tt_usuario_create,tt_usuario_update,tt_rol_list,tt_usuariorol_list" %}

  <li class="nav-item mt-3">
    <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">TalentTrack</h6>
  </li>

  <!-- Panel -->
  <li class="nav-item">
    <a class="nav-link {% if url_name == 'tt_dashboard' %}active{% endif %}" href="{% url 'tt_dashboard' %}">
      <span class="nav-link-text ms-1">Panel</span>
    </a>
  </li>

  {% if request.user.is_authenticated %}
    {% with is_employee_only=request.user|is_employee_only %}

      <!-- ADMINISTRACIÓN -->
      {% if request.user.is_superadmin or request.user|has_any_role:"ADMIN_RRHH" %}
        <li class="nav-item mt-3">
          <a class="nav-link d-flex align-items-center tt-nav-section {% if admin_active %}tt-open{% endif %}"
             data-bs-toggle="collapse"
             href="#ttAdminCollapse"
             role="button"
             aria-expanded="{% if admin_active %}true{% else %}false{% endif %}"
             aria-controls="ttAdminCollapse">
            <span class="nav-link-text ms-1">Administración</span>
</a>

          <div class="collapse {% if admin_active %}show{% endif %}" id="ttAdminCollapse">
            <ul class="nav nav-sm flex-column ms-4">
              {% if request.user.is_superadmin %}
                <li class="nav-item">
                  <a class="nav-link {% if url_name == 'tt_empresa_list' %}active{% endif %}" href="{% url 'tt_empresa_list' %}">
                    <span class="nav-link-text ms-1">Empresas</span>
                  </a>
                </li>
              {% endif %}
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'tt_unidad_list' %}active{% endif %}" href="{% url 'tt_unidad_list' %}">
                  <span class="nav-link-text ms-1">Departamentos</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'tt_puesto_list' %}active{% endif %}" href="{% url 'tt_puesto_list' %}">
                  <span class="nav-link-text ms-1">Puestos</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'tt_turno_list' %}active{% endif %}" href="{% url 'tt_turno_list' %}">
                  <span class="nav-link-text ms-1">Turnos</span>
                </a>
              </li>
            </ul>
          </div>
        </li>
      {% endif %}

      <!-- OPERACIÓN -->
      <li class="nav-item mt-3">
        <a class="nav-link d-flex align-items-center tt-nav-section {% if oper_active %}tt-open{% endif %}"
           data-bs-toggle="collapse"
           href="#ttOperCollapse"
           role="button"
           aria-expanded="{% if oper_active %}true{% else %}false{% endif %}"
           aria-controls="ttOperCollapse">
          <span class="nav-link-text ms-1">Operación</span>
</a>

        <div class="collapse {% if oper_active %}show{% endif %}" id="ttOperCollapse">
          <ul class="nav nav-sm flex-column ms-4">
            <li class="nav-item">
              <a class="nav-link {% if url_name == 'tt_empleado_list' %}active{% endif %}" href="{% url 'tt_empleado_list' %}">
                <span class="nav-link-text ms-1">{% if is_employee_only %}Mi perfil{% else %}Empleados{% endif %}</span>
              </a>
            </li>

            <!-- Asistencia -->
            <li class="nav-item">
              <a class="nav-link {% if url_name == 'tt_asistencia_hoy' %}active{% endif %}" href="{% url 'tt_asistencia_hoy' %}">
                <span class="nav-link-text ms-1">{% if is_employee_only %}Marcar asistencia{% else %}Asistencia (hoy){% endif %}</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if url_name == 'tt_asistencia_list' %}active{% endif %}" href="{% url 'tt_asistencia_list' %}">
                <span class="nav-link-text ms-1">{% if is_employee_only %}Mi asistencia{% else %}Historial de asistencia{% endif %}</span>
              </a>
            </li>

            <!-- Ausencias -->
            <li class="nav-item">
              <a class="nav-link {% if url_name == 'tt_ausencia_list' %}active{% endif %}" href="{% url 'tt_ausencia_list' %}">
                <span class="nav-link-text ms-1">{% if is_employee_only %}Mis ausencias{% else %}Permisos / Ausencias{% endif %}</span>
              </a>
            </li>

            <!-- KPIs -->
            <li class="nav-item">
              <a class="nav-link {% if url_name == 'tt_kpi_list' %}active{% endif %}" href="{% url 'tt_kpi_list' %}">
                <span class="nav-link-text ms-1">{% if is_employee_only %}Mis KPIs{% else %}KPIs{% endif %}</span>
              </a>
            </li>

            <!-- Evaluaciones (solo RRHH / Manager / Auditor / Superadmin) -->
            {% if not is_employee_only %}
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'tt_evaluacion_list' %}active{% endif %}" href="{% url 'tt_evaluacion_list' %}">
                  <span class="nav-link-text ms-1">Evaluaciones</span>
                </a>
              </li>
            {% endif %}
          </ul>
        </div>
      </li>

      <!-- SEGURIDAD -->
      {% if request.user.is_superadmin or request.user|has_any_role:"ADMIN_RRHH" %}
        <li class="nav-item mt-3">
          <a class="nav-link d-flex align-items-center tt-nav-section {% if sec_active %}tt-open{% endif %}"
             data-bs-toggle="collapse"
             href="#ttSecCollapse"
             role="button"
             aria-expanded="{% if sec_active %}true{% else %}false{% endif %}"
             aria-controls="ttSecCollapse">
            <span class="nav-link-text ms-1">Seguridad</span>
</a>

          <div class="collapse {% if sec_active %}show{% endif %}" id="ttSecCollapse">
            <ul class="nav nav-sm flex-column ms-4">
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'tt_usuario_list' %}active{% endif %}" href="{% url 'tt_usuario_list' %}">
                  <span class="nav-link-text ms-1">Usuarios</span>
                </a>
              </li>
              {% if request.user.is_superadmin %}
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'tt_rol_list' %}active{% endif %}" href="{% url 'tt_rol_list' %}">
                  <span class="nav-link-text ms-1">Roles</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'tt_usuariorol_list' %}active{% endif %}" href="{% url 'tt_usuariorol_list' %}">
                  <span class="nav-link-text ms-1">Asignación de roles</span>
                </a>
              </li>
              {% endif %}
            </ul>
          </div>
        </li>
      {% endif %}

    {% endwith %}
  {% endif %}

  {% endwith %}
  {% endwith %}
  {% endwith %}
  {% endwith %}

</ul>