{% extends "layouts/base.html" %}
{% load tt_roles %}
{% block content %}
<div class="container-fluid py-4">

  <div class="row">
    <div class="col-12">

      <div class="card mb-4">
        <div class="card-header pb-0 d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div>
            <h6 class="mb-0">Eventos de Asistencia</h6>
            <p class="text-sm text-secondary mb-0">Entrada / Salida</p>
          </div>

          <div class="d-flex gap-2">
            {% if can_mark %}
              <a class="btn btn-sm bg-gradient-dark" href="{% url 'tt_asistencia_hoy' %}">Marcar</a>
            {% endif %}
            {% if can_export %}
              <a class="btn btn-outline-primary btn-sm"
                 href="{% url 'tt_export_asistencia_csv' %}?{{ request.GET.urlencode }}">
                Exportar CSV
              </a>
            {% endif %}
          </div>
        </div>

        <div class="card-body pt-3">

	          <form method="get" class="row g-2 align-items-end mb-3">
            {% if is_superadmin %}
              <div class="col-12 col-lg-3">
                <label class="form-label text-sm mb-1">Empresa</label>
                <select name="empresa" class="form-control">
                  <option value="">Todas</option>
                  {% for e in empresa_options %}
                    <option value="{{ e.id }}" {% if empresa_filter == e.id|stringformat:"s" %}selected{% endif %}>{{ e }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}
	            <div class="col-12 col-lg-4">
	              <label class="form-label text-sm mb-1">Empleado</label>
	              <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Nombre, documento, correo‚Ä¶">
	            </div>
	            <div class="col-6 col-lg-2">
              <label class="form-label text-sm mb-1">Desde</label>
              <input type="date" name="desde" value="{{ desde }}" class="form-control">
            </div>
	            <div class="col-6 col-lg-2">
              <label class="form-label text-sm mb-1">Hasta</label>
              <input type="date" name="hasta" value="{{ hasta }}" class="form-control">
            </div>
	            <div class="col-12 col-lg-4 col-xl-3 d-flex justify-content-end tt-filter-actions">
	              <button class="btn btn-sm btn-outline-secondary mb-0" type="submit">Filtrar</button>
	              <a class="btn btn-sm btn-outline-secondary mb-0" href="{% url 'tt_asistencia_list' %}">Limpiar</a>
            </div>
          </form>

          {% if request.user|has_role:"EMPLEADO" and request.user.empleado_id %}
            <div class="row g-3 mb-3">
              <div class="col-12 col-xl-4">
                <div class="card tt-emp-summary">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <div class="text-xs text-secondary">Mi turno hoy</div>
                        <div class="fw-bold">
                          {% if turno_hoy %}{{ turno_hoy.nombre }}{% else %}Sin turno asignado{% endif %}
                        </div>
                        <div class="text-sm text-secondary">
                          {% if turno_hoy and turno_hoy.hora_inicio and turno_hoy.hora_fin %}
                            {{ turno_hoy.hora_inicio|time:"H:i" }} ‚Äì {{ turno_hoy.hora_fin|time:"H:i" }}
                          {% else %}
                            ‚Äî
                          {% endif %}
                        </div>
                      </div>
                      <div class="text-end">
                        {% if turno_hoy and turno_hoy.requiere_gps %}
                          <span class="tt-chip tt-chip-warn">GPS</span>
                        {% endif %}
                        {% if turno_hoy and turno_hoy.requiere_foto %}
                          <span class="tt-chip tt-chip-warn">Foto</span>
                        {% endif %}
                      </div>
                    </div>

                    <hr class="horizontal dark my-3">

                    <div class="text-xs text-secondary mb-2">√öltimas marcaciones</div>
                    <div class="tt-timeline">
                      {% for ev in eventos_recent %}
                        <div class="tt-timeline-item">
                          <div class="tt-timeline-dot"></div>
                          <div class="tt-timeline-content">
                            <div class="d-flex justify-content-between align-items-center">
                              <div class="fw-semibold text-sm">{{ ev.tt_label }}</div>
                              <div class="text-xs text-secondary">{{ ev.registrado_el|date:"Y-m-d H:i" }}</div>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mt-1">
                              {% if ev.tt_has_gps %}<span class="tt-chip">üìç GPS</span>{% endif %}
                              {% if ev.dentro_geocerca %}<span class="tt-chip">‚úÖ Geocerca</span>{% elif ev.dentro_geocerca is not None %}<span class="tt-chip tt-chip-danger">‚ö†Ô∏è Fuera</span>{% endif %}
                              {% if ev.tt_has_photo %}<span class="tt-chip">üì∑ Foto</span>{% endif %}
                            </div>
                          </div>
                        </div>
                      {% empty %}
                        <div class="text-sm text-secondary">A√∫n no tienes marcaciones.</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-xl-8">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div>
                        <div class="fw-bold">Mis jornadas recientes</div>
                        <div class="text-xs text-secondary">√öltimos 7 d√≠as</div>
                      </div>
                      <a class="btn btn-sm btn-outline-primary mb-0" href="{% url 'tt_asistencia_hoy' %}">Marcar ahora</a>
                    </div>

                    <div class="row g-3">
                      {% for j in jornadas_recent %}
                        <div class="col-12 col-md-6 col-xxl-4">
                          <div class="tt-jornada">
                            <div class="d-flex justify-content-between align-items-center">
                              <div class="fw-semibold">{{ j.fecha }}</div>
                              {% if j.minutos_tardanza and j.minutos_tardanza|add:0 > 0 %}
                                <span class="badge bg-gradient-warning">Tarde {{ j.minutos_tardanza }}m</span>
                              {% else %}
                                <span class="badge bg-gradient-success">A tiempo</span>
                              {% endif %}
                            </div>
                            <div class="text-sm text-secondary mt-1">Trabajado: {{ j.minutos_trabajados|default:0|floatformat:0 }} min</div>
                            <div class="text-xs text-secondary">Extra: {{ j.minutos_extra|default:0|floatformat:0 }} min</div>
                          </div>
                        </div>
                      {% empty %}
                        <div class="col-12">
                          <div class="text-sm text-secondary">No hay jornadas calculadas todav√≠a.</div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <!-- Bandeja (estilo similar a Ausencias) -->
          <div class="row g-3">
            {% for ev in eventos %}
              <div class="col-12 col-xl-6">
                <div class="card tt-att-card">
                  <div class="card-body">

                    <div class="d-flex justify-content-between align-items-start">
                      <div class="d-flex align-items-center gap-3">
                        <div class="tt-avatar">
                          {{ ev.empleado.apellidos|default:""|slice:":1" }}{{ ev.empleado.nombres|default:""|slice:":1" }}
                        </div>
                        <div>
                          <div class="fw-bold text-sm mb-0">{{ ev.empleado }}</div>
                          <div class="text-xs text-secondary">
                            {{ ev.empresa }}
                            {% if ev.empleado.email %}¬∑ {{ ev.empleado.email }}{% endif %}
                          </div>
                        </div>
                      </div>

                      <div class="text-end">
                        <span class="badge bg-gradient-{{ ev.tt_badge|default:'secondary' }}">{{ ev.tt_label|default:'Marcaci√≥n' }}</span>
                        <div class="text-xs text-secondary mt-1">
                          {% if ev.registrado_el %}{{ ev.registrado_el|date:"Y-m-d H:i" }}{% else %}‚Äî{% endif %}
                        </div>
                      </div>
                    </div>

                    <div class="tt-att-meta mt-3">
                      <div class="tt-att-meta-item">
                        <div class="text-xs text-secondary">GPS</div>
                        <div class="tt-att-kv text-sm fw-semibold">
                          {% if ev.tt_has_gps %}
                            <span class="tt-chip">üìç Capturado</span>
                          {% else %}
                            <span class="text-secondary">‚Äî</span>
                          {% endif %}
                        </div>
                      </div>

                      <div class="tt-att-meta-item">
                        <div class="text-xs text-secondary">Geocerca</div>
                        <div class="tt-att-kv text-sm fw-semibold">
                          {% if ev.dentro_geocerca %}
                            <span class="badge bg-gradient-success">Dentro</span>
                          {% elif ev.dentro_geocerca is not None %}
                            <span class="badge bg-gradient-danger">Fuera</span>
                          {% else %}
                            <span class="text-secondary">‚Äî</span>
                          {% endif %}
                        </div>
                      </div>

                      <div class="tt-att-meta-item tt-att-meta-wide">
                        <div class="text-xs text-secondary">Detalle</div>
                        <div class="d-flex flex-wrap gap-2 mb-1">
                          {% if ev.tt_has_photo %}<span class="tt-chip">üì∑ Foto</span>{% endif %}
                          {% if ev.tt_has_gps %}<span class="tt-chip">üìç GPS</span>{% endif %}
                          {% if ev.dentro_geocerca %}<span class="tt-chip">‚úÖ Geocerca</span>{% elif ev.dentro_geocerca is not None %}<span class="tt-chip tt-chip-danger">‚ö†Ô∏è Fuera</span>{% endif %}
                        </div>
                        <div class="text-sm tt-att-ellipsis">{{ ev.observacion|default:"‚Äî" }}</div>
                      </div>
                    </div>

                    <div class="d-flex flex-wrap justify-content-end gap-2 mt-3">
                      <button type="button" class="btn btn-sm btn-outline-secondary mb-0"
                              data-bs-toggle="modal" data-bs-target="#attModal{{ ev.id }}">
                        Ver detalle
                      </button>
                    </div>

                  </div>
                </div>
              </div>

              <!-- Modal detalle -->
              <div class="modal fade" id="attModal{{ ev.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Evento de asistencia</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <div class="text-xs text-secondary">Empleado</div>
                          <div class="fw-semibold">{{ ev.empleado }}</div>
                        </div>
                        <div class="col-md-6">
                          <div class="text-xs text-secondary">Empresa</div>
                          <div class="fw-semibold">{{ ev.empresa }}</div>
                        </div>
                        <div class="col-md-6">
                          <div class="text-xs text-secondary">Tipo</div>
                          <div class="fw-semibold">{{ ev.tt_label|default:ev.tipo }}</div>
                        </div>
                        <div class="col-md-6">
                          <div class="text-xs text-secondary">Fecha / hora</div>
                          <div class="fw-semibold">{{ ev.registrado_el|date:"Y-m-d H:i" }}</div>
                        </div>
                        <div class="col-md-6">
                          <div class="text-xs text-secondary">GPS</div>
                          <div class="fw-semibold">
                            {% if ev.tt_has_gps %}
                              {% if request.user|has_any_role:"SUPERADMIN,ADMIN_RRHH,AUDITOR" %}
                                {{ ev.gps_lat }}, {{ ev.gps_lng }}
                              {% else %}
                                {{ ev.tt_gps_masked|default:"Capturado" }}
                              {% endif %}
                            {% else %}
                              ‚Äî
                            {% endif %}
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="text-xs text-secondary">Foto</div>
                          <div class="fw-semibold">
                            {% if ev.foto_url %}
                              <a href="{{ ev.foto_url }}" target="_blank" rel="noopener">Ver foto</a>
                            {% else %}
                              ‚Äî
                            {% endif %}
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="text-xs text-secondary">Geocerca</div>
                          <div class="fw-semibold">
                            {% if ev.dentro_geocerca %}
                              Dentro
                            {% elif ev.dentro_geocerca is not None %}
                              Fuera
                            {% else %}
                              ‚Äî
                            {% endif %}
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="text-xs text-secondary">Observaci√≥n</div>
                          <div class="tt-abs-pre">{{ ev.observacion|default:"‚Äî" }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </div>
                </div>
              </div>

            {% empty %}
              <div class="col-12">
                <div class="text-center text-secondary py-4">No hay eventos para los filtros seleccionados.</div>
              </div>
            {% endfor %}
          </div>

        </div>
      </div>

    </div>
  </div>

</div>
{% endblock %}
