{% extends "layouts/base.html" %}
{% load static tt_form_extras %}

{% block extrastyle %}
  {{ block.super }}
  {% if 'geocerca_lat' in form.fields %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
      #tt-geofence-map { height: 340px; border-radius: 14px; overflow: hidden; border: 1px solid rgba(0,0,0,.06); }
      .tt-geofence-panel { border-radius: 14px; background: #fff; border: 1px solid rgba(0,0,0,.06); padding: 14px; }
      .tt-geofence-chip { display:inline-flex; align-items:center; gap:.45rem; padding:.35rem .6rem; border-radius: 999px; border:1px solid rgba(0,0,0,.08); background: rgba(17, 205, 239, .06); font-size:.78rem; color:#2a3f5f; }
      .tt-geofence-chip i { font-size: .9rem; }
    </style>
  {% endif %}
{% endblock extrastyle %}
{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12 col-lg-10">
      <div class="card">
        <div class="card-header pb-0">
          <h6>{{ title }}</h6>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div data-tt-dependent-selects
                 data-unidades-url="{% url 'tt_ajax_unidades' %}"
                 data-puestos-url="{% url 'tt_ajax_puestos' %}"
                 data-empleados-url="{% url 'tt_ajax_empleados' %}"
                 data-managers-url="{% url 'tt_ajax_managers' %}"
                 data-roles-url="{% url 'tt_ajax_roles' %}"
                 data-turnos-url="{% url 'tt_ajax_turnos' %}"></div>

            {% if form.non_field_errors %}
              <div class="alert alert-danger text-sm">{{ form.non_field_errors }}</div>
            {% endif %}

            {# Render con secciones (fieldsets) si el formulario lo define; caso contrario, render normal #}

            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}

            {% if 'geocerca_lat' in form.fields %}
              <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <h6 class="text-sm text-uppercase text-secondary mb-0">Ubicación y geocerca</h6>
                  <span class="tt-geofence-chip">
                    <i class="ni ni-pin-3"></i>
                    Click en el mapa para fijar la sede
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-12 col-lg-8">
                    <div id="tt-geofence-map"></div>
                    <div class="text-xs text-secondary mt-2">
                      Ajusta el radio para definir el rango permitido alrededor de la empresa.
                    </div>

                    {% if form.geocerca_lat.errors or form.geocerca_lng.errors %}
                      <div class="text-danger text-xs mt-2">
                        {{ form.geocerca_lat.errors }}{{ form.geocerca_lng.errors }}
                      </div>
                    {% endif %}
                  </div>
                  <div class="col-12 col-lg-4">
                    <div class="tt-geofence-panel">
                      <label class="form-control-label">Radio (metros)<span class="text-danger"> *</span></label>
                      <input id="tt-geofence-radius-range" type="range" min="25" max="2000" step="25" class="form-range" />
                      <div class="d-flex gap-2 align-items-center">
                        <input id="tt-geofence-radius-number" type="number" min="25" max="2000" step="25" class="form-control" />
                        <span class="text-xs text-secondary">m</span>
                      </div>

                      <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary mb-0" id="tt-geofence-locate">Usar mi ubicación</button>
                        <div class="text-xs text-secondary mt-2">
                          Tip: luego mueve el punto si necesitas precisión.
                        </div>
                      </div>

                      {% if form.geocerca_radio_m.errors %}
                        <div class="text-danger text-xs mt-2">{{ form.geocerca_radio_m.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}

            {% if form.fieldsets %}
              {% for fs in form.fieldsets %}
                <div class="mb-4">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="text-sm text-uppercase text-secondary mb-0">{{ fs.0 }}</h6>
                  </div>
                  <div class="row">
                    {% for name in fs.1 %}
                      {% with field=form|tt_field:name %}
                        {% if field %}
                          {% if field.name == 'dias_semana' %}
                          <div class="col-12">
                          {% else %}
                          <div class="col-12 col-md-6">
                          {% endif %}
                            <div class="form-group mb-3">
                              <label class="form-control-label" for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="text-danger"> *</span>{% endif %}</label>
                              {% if field.name == 'dias_semana' %}
                              {{ field }}
                              {% else %}
                              {{ field }}
                              {% endif %}
                              {% if field.help_text %}
                                <div class="text-xs text-secondary">{{ field.help_text }}</div>
                              {% endif %}
                              {% for err in field.errors %}
                                <div class="text-danger text-xs">{{ err }}</div>
                              {% endfor %}
                            </div>
                          </div>
                        {% endif %}
                      {% endwith %}
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}

            {% else %}
              <div class="row">
                {% for field in form.visible_fields %}
                  {% if field.name == 'dias_semana' %}
                  <div class="col-12">
                  {% else %}
                  <div class="col-12 col-md-6">
                  {% endif %}
                    <div class="form-group mb-3">
                      <label class="form-control-label" for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="text-danger"> *</span>{% endif %}</label>
                      {% if field.name == 'dias_semana' %}
                      {{ field }}
                      {% else %}
                      {{ field }}
                      {% endif %}
                      {% if field.help_text %}
                        <div class="text-xs text-secondary">{{ field.help_text }}</div>
                      {% endif %}
                      {% for err in field.errors %}
                        <div class="text-danger text-xs">{{ err }}</div>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary mb-0">Guardar</button>
              <a class="btn btn-outline-secondary mb-0" href="javascript:history.back()">Cancelar</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // aplica clases bootstrap a inputs/selects generados
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if (!el.classList.contains("form-control") && el.type !== "checkbox") el.classList.add("form-control");
    if (el.type === "checkbox" && !el.closest(".tt-weekdays")) el.classList.add("form-check-input");
  });
</script>
{% endblock content %}

{% block extra_js %}
  {% if enable_dependent_selects_usuario %}
    <script src="{% static 'assets/js/plugins/choices.min.js' %}"></script>
    <script src="{% static 'assets/js/talenttrack/dependent_selects.js' %}"></script>
  {% endif %}

  {% if 'geocerca_lat' in form.fields %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
      (function(){
        const latInput = document.getElementById('id_geocerca_lat');
        const lngInput = document.getElementById('id_geocerca_lng');
        const radiusHidden = document.getElementById('id_geocerca_radio_m');
        const range = document.getElementById('tt-geofence-radius-range');
        const number = document.getElementById('tt-geofence-radius-number');

        // defaults
        const defaultLat = -2.170997;
        const defaultLng = -79.922359;

        let lat = parseFloat(latInput?.value || '') || defaultLat;
        let lng = parseFloat(lngInput?.value || '') || defaultLng;
        let radius = parseInt(radiusHidden?.value || '150', 10);

        // Si el formulario viene vacío, precarga valores por defecto para que pase validación
        if (latInput && !latInput.value) latInput.value = String(lat);
        if (lngInput && !lngInput.value) lngInput.value = String(lng);
        if (radiusHidden && !radiusHidden.value) radiusHidden.value = String(radius);

        let marker = null;
        let circle = null;

        function setRadius(v){
          const r = Math.max(25, Math.min(2000, parseInt(v || '150', 10)));
          radius = r;
          if (radiusHidden) radiusHidden.value = String(r);
          if (range) range.value = String(r);
          if (number) number.value = String(r);
          if (circle) circle.setRadius(r);
        }

        // Init controls
        if (range) range.value = String(radius);
        if (number) number.value = String(radius);
        setRadius(radius);

        // Map
        const map = L.map('tt-geofence-map', { zoomControl: true }).setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        circle = L.circle([lat, lng], { radius: radius }).addTo(map);

        function setPoint(newLat, newLng){
          lat = newLat; lng = newLng;
          if (latInput) latInput.value = String(newLat);
          if (lngInput) lngInput.value = String(newLng);
          marker.setLatLng([newLat, newLng]);
          circle.setLatLng([newLat, newLng]);
        }

        map.on('click', function(e){
          setPoint(e.latlng.lat, e.latlng.lng);
        });
        marker.on('dragend', function(){
          const p = marker.getLatLng();
          setPoint(p.lat, p.lng);
        });

        if (range) range.addEventListener('input', (e) => setRadius(e.target.value));
        if (number) number.addEventListener('change', (e) => setRadius(e.target.value));

        const locateBtn = document.getElementById('tt-geofence-locate');
        if (locateBtn && navigator.geolocation){
          locateBtn.addEventListener('click', () => {
            navigator.geolocation.getCurrentPosition((pos) => {
              const la = pos.coords.latitude;
              const lo = pos.coords.longitude;
              setPoint(la, lo);
              map.setView([la, lo], 16);
            }, () => {
              alert('No se pudo obtener tu ubicación. Revisa permisos del navegador.');
            }, { enableHighAccuracy: true, timeout: 8000 });
          });
        }
      })();
    </script>
  {% endif %}
{% endblock extra_js %}